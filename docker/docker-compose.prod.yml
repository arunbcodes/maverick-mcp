# Production Docker Compose Overrides
# Use with: docker compose -f docker/docker-compose.yml -f docker/docker-compose.prod.yml up -d
#
# Changes from development:
#   - No volume mounts (use built images)
#   - Resource limits
#   - Production environment variables
#   - Optimized health checks

services:
  web:
    image: maverick-web:${VERSION:-latest}
    restart: always
    environment:
      - NODE_ENV=production
      - API_URL=http://api:8000
      - NEXT_PUBLIC_API_URL=${PUBLIC_API_URL:-http://localhost:8000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    image: maverick-api:${VERSION:-latest}
    restart: always
    # Remove volume mounts - use built image
    volumes: []
    environment:
      - MAVERICK_ENVIRONMENT=production
      - MAVERICK_DEBUG=false
      - MAVERICK_DATABASE_URL=postgresql+asyncpg://${DB_USER:-postgres}:${DB_PASSWORD:?DB_PASSWORD required}@postgres:5432/${DB_NAME:-maverick_mcp}
      - MAVERICK_REDIS_URL=redis://redis:6379
      - MAVERICK_JWT_SECRET=${JWT_SECRET:?JWT_SECRET required}
      - MAVERICK_CORS_ORIGINS=${CORS_ORIGINS:-}
      - MAVERICK_TIINGO_API_KEY=${TIINGO_API_KEY:?TIINGO_API_KEY required}
      - MAVERICK_OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - MAVERICK_ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    command: ["uvicorn", "maverick_api:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mcp:
    image: maverick-mcp:${VERSION:-latest}
    restart: always
    # Remove volume mounts - use built image
    volumes: []
    environment:
      - DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:?DB_PASSWORD required}@postgres:5432/${DB_NAME:-maverick_mcp}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOG_LEVEL=warning
      - ENVIRONMENT=production
      - TIINGO_API_KEY=${TIINGO_API_KEY:?TIINGO_API_KEY required}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - EXA_API_KEY=${EXA_API_KEY:-}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - FRED_API_KEY=${FRED_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres:
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:?DB_PASSWORD required}
      - POSTGRES_DB=${DB_NAME:-maverick_mcp}
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    restart: always
    command:
      - redis-server
      - --maxmemory 512mb
      - --maxmemory-policy allkeys-lru
      - --appendonly yes
      - --appendfsync everysec
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

